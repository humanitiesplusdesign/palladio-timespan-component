angular.module("palladioTableComponent",["palladio","palladio.services"]).run(["componentService",function(n){var e=function(n,e){n.showSettings=void 0===n.showSettings?!1:n.showSettings,n.tableHeight=void 0===n.height?void 0:n.height;var t='<div class="with-settings" data-palladio-table-view-with-settings ';return t+="show-settings=showSettings ",t+="table-height=tableHeight ",n.dimensions&&(t+='config-dimensions="dimensions" '),n.row&&(t+='config-row="row" '),t+="></div>"};n.register("table",e)}]).directive("palladioTableView",["palladioService",function(n){return{scope:{dimensions:"=",dimension:"=",tableHeight:"=",xfilter:"=",exportFunc:"="},link:function(e,t,i){function o(){e.tableHeight?e.calcHeight=e.tableHeight:e.calcHeight=$(window).height(),t.height(e.calcHeight),$(t[0].nextElementSibling).height(e.calcHeight)}function a(){if(e.dimension&&l&&0!==v.length){c||(c=v[0].key),d=d3.select(t[0]).select("table"),d.empty()&&(d=d3.select(t[0]).append("table").attr("class","table table-striped"),d.append("thead").append("tr"),d.append("tbody")),r=d.select("tr").selectAll("th").data(v,function(n){return n.key}),r.exit().remove(),r.enter().append("th").text(function(n){return n.key+" "}).style("cursor","pointer").on("click",function(n){m=c==n.key?!m:m,c=n.key,p=function(n,e){return m?n[c]<e[c]?1:-1:n[c]<e[c]?-1:1},a()}).append("i").style("margin-left","5px"),r.select("i").attr("class",function(){return m?"fa fa-sort-asc":"fa fa-sort-desc"}).style("opacity",function(n){return n.key==c?1:0}),r.order();var n=[],i=d3.nest().key(l.accessor).rollup(function(e){return v.map(function(t){return n=[],e.forEach(function(e){-1===n.indexOf(e[t.key])&&e[t.key]&&n.push(e[t.key])}),{key:t.key,values:n}}).reduce(function(n,e){return n[e.key]=e.values.join(", "),n},{})}).entries(l.top(1/0)).map(function(n){return n.values[e.dimension.key]=n.key,n.values});u=d.select("tbody").selectAll("tr").data(i.filter(function(n){return g?-1!==v.map(function(e){return n[e.key]}).join().toUpperCase().indexOf(g.toUpperCase()):!0}).sort(p),function(n){return v.map(function(e){return n[e.key]}).join()+l.accessor(n)}),u.exit().remove(),u.enter().append("tr"),u.order(),f=u.selectAll("td").data(function(n){return v.map(function(e){return{key:e.key,value:n[e.key]}})},function(n){return n.key}),f.exit().remove(),f.enter().append("td"),f.html(function(n){return 0===n.value.indexOf("https://")||0===n.value.indexOf("http://")||0===n.value.indexOf("www.")?"<a target='_blank' href='"+n.value+"'>"+n.value+"</a>":n.value}),f.order()}}function s(){e.dimension&&(v=[e.dimension].concat(e.dimensions))}$(document).ready(o),$(window).resize(o);var l,c,d,r,u,f,p=function(){},m=!0,g="",v=[];e.exportFunc=function(){function n(){return window.Blob||window.WebKitBlob||window.MozBlob}var e=d3.csv.format(f.map(function(n){var e={};return n.forEach(function(n){e[n.__data__.key]=n.__data__.value}),e})),t="Palladio table export.csv",i=n(),o=-1!=navigator.userAgent.indexOf("Safari")&&-1==navigator.userAgent.indexOf("Chrome");if(o){var a="data:text/csv,"+e;window.open(a,"download")}else{var s=new i([e],{type:"data:text/csv"});saveAs(s,t)}};var h="tableView"+Math.floor(1e4*Math.random()),w=[];w.push(n.onUpdate(h,function(){t.is(":visible")&&a()})),e.$watch(function(){return t.is(":visible")},a),e.$watchCollection("dimensions",function(){s(),a()}),e.$watch("dimension",function(){s(),e.dimension&&(l&&l.remove(),l=e.xfilter.dimension(function(n){return""+n[e.dimension.key]}),l.accessor=function(n){return""+n[e.dimension.key]}),a()}),e.$on("$destroy",function(){l&&l.remove(),w.forEach(function(n){n()})}),w.push(n.onSearch(h,function(n){g=n,a()}))}}}]).directive("palladioTableViewWithSettings",["palladioService","dataService",function(n,e){return{scope:{tableHeight:"=",showSettings:"=",configDimensions:"=",configRow:"="},templateUrl:"partials/palladio-table-component/template.html",link:{pre:function(t,i,o){function a(n){t.$apply(function(){t.tableDimensions=n.tableDimensions,t.countDim=n.countDim,t.setInternalState(n)})}function s(){return t.readInternalState({tableDimensions:t.tableDimensions,countDim:t.countDim})}var l=[];t.metadata=e.getDataSync().metadata,t.xfilter=e.getDataSync().xfilter,t.uniqueToggleId="tableView"+Math.floor(1e4*Math.random()),t.uniqueModalId=t.uniqueToggleId+"modal",t.fields=t.metadata.sort(function(n,e){return n.description<e.description?-1:1}),t.tableDimensions=[],t.countDims=t.metadata.sort(function(n,e){return n.description<e.description?-1:1}),t.countDim=null,t.configRow&&(t.countDim=t.countDims.filter(function(n){return n.key===t.configRow.key})[0]),t.configDimensions&&t.configDimensions.forEach(function(n){t.tableDimensions.push(t.fields.filter(function(e){return e.key===n.key})[0])}),t.getCountDescription=function(n){return n.description},t.showCountModal=function(){$("#"+t.uniqueModalId).find("#count-modal").modal("show")},t.showModal=function(){$("#table-modal").modal("show")},t.fieldDescriptions=function(){return t.tableDimensions.map(function(n){return n.description}).join(", ")},t.setInternalState=function(n){return n},t.readInternalState=function(n){return n},t.exportCsv=function(){},l.push(n.registerStateFunctions(t.uniqueToggleId,"tableView",s,a)),t.$on("$destroy",function(){l.forEach(function(n){n()})})},post:function(n,e,t){e.find(".settings-toggle").click(function(){e.find(".settings").toggleClass("closed")})}}}}]),angular.module("palladio").run(["$templateCache",function(n){n.put("partials/palladio-table-component/template.html",'<div class="">\n\n		<div data-ng-show="countDim"\n			data-palladio-table-view\n			dimension="countDim"\n			table-height="tableHeight"\n			dimensions="tableDimensions"\n			xfilter="xfilter"\n			export-func="exportCsv">\n		</div>\n\n</div>\n\n<!-- Settings -->\n<div class="row" data-ng-show="showSettings || showSettings === undefined">\n\n    <div class="settings col-lg-4 col-lg-offset-8 col-md-6 col-md-offset-6">\n      <div class="panel panel-default">\n\n        <a class="settings-toggle" data-toggle="tooltip" data-original-title="Settings" data-placement="bottom">\n          <i class="fa fa-bars"></i>\n        </a>\n\n        <div class="panel-body">\n\n          <div class="row">\n            <div class="col-lg-12">\n              <label>Settings</label>\n            </div>\n          </div>\n\n          <div class="row margin-top">\n            <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 text-right">\n              <label class="inline">Row dimension</label>\n            </div>\n            <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8 col-condensed">\n              <span class="btn btn-default" ng-click="showCountModal()">\n                  {{countDim.description || "Choose"}}\n                  <span class="caret"></span>\n              </span>\n							<p class="help-block">At least one row per value in this dimension. Multiple values will be displayed as lists in each cell.</p>\n\n            </div>\n          </div>\n\n          <div class="row margin-top">\n            <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 text-right">\n              <label class="inline">Dimensions</label>\n            </div>\n            <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8 col-condensed">\n							<span class="btn btn-default" ng-click="showModal()">\n                  {{fieldDescriptions() || "Choose"}}\n                  <span class="caret"></span>\n              </span>\n            </div>\n          </div>\n\n					<div class="row margin-top">\n            <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 text-right">\n            </div>\n            <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8 col-condensed">\n\n              <a class="pull-right"\n							tooltip="Download data (csv)"\n							tooltip-animation="false"\n							tooltip-append-to-body="true"\n							ng-click="exportCsv()">\n								<i class="fa fa-download margin-right"></i>Download\n							</a>\n\n            </div>\n          </div>\n\n\n        </div>\n      </div>\n    </div>\n\n</div>\n\n<div id="{{uniqueModalId}}" data-ng-show="showSettings || showSettings === undefined">\n	<div id="table-modal" data-modal description="Choose data dimensions" dimensions="fields" model="tableDimensions" sortable="true"></div>\n	<div id="count-modal" data-modal description="Choose key dimension (one row for each value of this dimension)" dimensions="countDims" model="countDim" description-accessor="getCountDescription"></div>\n</div>\n')}]);