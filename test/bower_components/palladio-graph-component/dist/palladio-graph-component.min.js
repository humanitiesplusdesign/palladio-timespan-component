angular.module("palladioGraphComponent",["palladio.services","palladio"]).run(["componentService",function(n){var i=function(n,i){n.showSettings=void 0===n.showSettings?!0:n.showSettings,n.graphHeight=void 0===n.height?"100%":n.height,n.functions={};var e='<div class="with-settings" data-palladio-graph-view-with-settings ';return e+="show-settings=showSettings ",e+="graph-height=graphHeight ",e+="functions=functions ",e+="></div>"};n.register("graph",i)}]).directive("palladioGraphView",["palladioService",function(n){return{scope:{linkDimension:"=",graphHeight:"=",showLinks:"=",showLabels:"=",nodeSize:"=",highlightSource:"=",highlightTarget:"=",countBy:"@",countDescription:"@",aggregationType:"@",aggregateKey:"@",readInternalState:"=",setInternalState:"=",getSvg:"="},link:function(i,e,t){function o(){i.linkDimension&&(m.width(r).height(d).showLinks(i.showLinks).showLabels(i.showLabels).nodeSize(i.nodeSize).searchText(c).circle(i.circleLayout),h.attr("width",r).attr("height",d),u.attr("width",r).attr("height",d).datum(a()).call(m),i.highlightSource&&m.highlightSource(),i.highlightTarget&&m.highlightTarget())}function a(){if(!p){var n=crossfilterHelpers.countByDimensionWithInitialCountAndData(function(n){return n[i.countBy]},function(n,e,t){return void 0===e&&(e={source:i.linkDimension.accessor(n)[0],target:i.linkDimension.accessor(n)[1],data:n,agg:0,initialAgg:0}),"add"===t?("COUNT"===i.aggregationType?e.agg++:e.agg=e.agg+(+n[i.aggregateKey]?+n[i.aggregateKey]:0),e.agg>e.initialAgg&&(e.initialAgg=e.agg)):"COUNT"===i.aggregationType?e.agg--:e.agg=e.agg-(+n[i.aggregateKey]?+n[i.aggregateKey]:0),e});p=i.linkDimension.group().reduce(n.add,n.remove,n.init).order(function(n){return n.data.agg})}return p.top(1/0).map(function(n){return n.value}).filter(function(n){return n.data.agg>0})}function l(){e.height(i.graphHeight?i.graphHeight.slice(0,i.graphHeight.length-2):$(window).height())}var g=[],s="graphView"+Math.floor(1e4*Math.random());i.readInternalState=function(n){return n.fixedNodes=m.fixedNodes(),n},i.setInternalState=function(n){return m.fixedNodes(n.fixedNodes),n},i.getSvg=function(){return m.getSvg()};var c="",r=e.width()||1e3,d=i.graphHeight&&-1===i.graphHeight.indexOf("%")?i.graphHeight.slice(0,i.graphHeight.length-2):e.height()||800,h=d3.select(e[0]).append("canvas").attr("style","position: absolute; left: 0; top: 0; z-index: -100"),u=d3.select(e[0]).append("svg:svg"),m=d3.graph(),p=null;i.$on("zoomIn",function(){m.zoomIn()}),i.$on("zoomOut",function(){m.zoomOut()}),i.$on("zoomToData",function(){m.zoomToData()}),g.push(n.onUpdate(s,function(){e.is(":visible")&&o()})),i.$watch(function(){return e.is(":visible")},o),i.$on("resetNodes",function(){m.resetNodes()}),i.$watch("linkDimension",function(){m.reset(),p&&(p.remove(),p=null),o()}),i.$watchGroup(["countBy","aggregationType","aggregationKey"],function(){m.reset(),p&&(p.remove(),p=null),o()}),i.$watch("showLinks",o),i.$watch("showLabels",o),i.$watch("nodeSize",o),g.push(n.onSearch(s,function(n){c=n,o()})),i.$watch("circleLayout",o),i.$watch("highlightSource",function(n,e){n!==e&&(n?(i.highlightTarget=!1,m.highlightSource()):i.highlightTarget||m.removeHighlight())}),i.$watch("highlightTarget",function(n,e){n!==e&&(n?(i.highlightSource=!1,m.highlightTarget()):i.highlightSource||m.removeHighlight())}),i.$on("resize",function(){r=e.width(),o()}),$(document).ready(l),$(window).resize(l)}}}]).directive("palladioGraphViewWithSettings",["exportService","palladioService","dataService",function(n,i,e){return{scope:{showSettings:"=",graphHeight:"=",functions:"="},templateUrl:"partials/palladio-graph-component/template.html",link:{pre:function(t,o,a){function l(){var n=t.mapping.sourceDimension?function(n){return n[t.mapping.sourceDimension.key]}:null,i=t.mapping.targetDimension?function(n){return n[t.mapping.targetDimension.key]}:null;t.linkDimension&&t.linkDimension.remove(),t.mapping.sourceDimension&&t.mapping.targetDimension&&(t.linkDimension=t.xfilter.dimension(function(e){return[n(e),i(e)]}),t.linkDimension.accessor=function(e){return[n(e),i(e)]})}function g(n){t.showLinks=n.showLinks,t.showLabels=n.showLabels,t.nodeSize=n.nodeSize,t.highlightSource=n.highlightSource,t.highlightTarget=n.highlightTarget,t.countDim=n.countDim,t.mapping.sourceDimension=t.fields.filter(function(i){return i.key===n.sourceDimension})[0],t.mapping.targetDimension=t.fields.filter(function(i){return i.key===n.targetDimension})[0],n.aggDimKey&&(t.aggDim=t.aggDims.filter(function(i){return i.key===n.aggDimKey})[0]),t.$digest(),t.setInternalState(n)}function s(){return t.readInternalState({showLinks:t.showLinks,showLabels:t.showLabels,aggregateKey:t.aggregateKey,aggregationType:t.aggregationType,nodeSize:t.nodeSize,highlightSource:t.highlightSource,highlightTarget:t.highlightTarget,countDim:t.countDim,aggDimKey:t.aggDim.key,sourceDimension:t.mapping.sourceDimension?t.mapping.sourceDimension.key:null,targetDimension:t.mapping.targetDimension?t.mapping.targetDimension.key:null})}void 0===t.showSettings?t.settings=!0:t.settings=t.showSettings;var c=[];t.metadata=e.getDataSync().metadata,t.xfilter=e.getDataSync().xfilter,t.uniqueToggleId="graphView"+Math.floor(1e4*Math.random()),t.uniqueModalId=t.uniqueToggleId+"modal",t.fields=t.metadata.sort(function(n,i){return n.description<i.description?-1:1}),t.dateFields=t.metadata.filter(function(n){return"date"===n.type}),t.mapping={},t.nodeSize=!1,t.showLabels=!0,t.circleLayout=!1,t.highlightSource=!1,t.highlightTarget=!1,t.showLinks=!0,t.getAggDescription=function(n){return"count"===n.type?"Number of "+n.field.countDescription:"Sum of "+n.field.description+" (from "+r.get(n.fileId).countDescription+" table)"};var r=d3.map();t.metadata.filter(function(n){return n.countable===!0}).forEach(function(n){r.set(n.originFileId?n.originFileId:0,n)}),t.aggDims=t.metadata.filter(function(n){return n.countable===!0||"number"===n.type}).map(function(n){return{key:n.key,type:n.countable?"count":"sum",field:n,fileId:n.originFileId?n.originFileId:0}}).filter(function(n){return!!r.get(n.fileId)}).sort(function(n,i){return t.getAggDescription(n)<t.getAggDescription(i)?-1:1}),t.aggDim=t.aggDims[0],t.$watch("aggDim",function(){t.aggDim?"count"===t.aggDim.type?(t.countBy=t.aggDim.key,t.aggregationType="COUNT",t.aggregateKey=null,t.aggDescription=t.getAggDescription(t.aggDim)):(t.countBy=r.get(t.aggDim.fileId).key,t.aggregationType="SUM",t.aggregateKey=t.aggDim.key,t.aggDescription=t.getAggDescription(t.aggDim)):t.countBy=t.countDims.get(0).key}),t.showAggModal=function(){$("#"+t.uniqueModalId).find("#agg-modal").modal("show")},t.$watch("mapping.sourceDimension",function(){l()}),t.$watch("mapping.targetDimension",function(){l()}),t.$on("$destroy",function(){t.linkDimension&&t.linkDimension.remove(),c.forEach(function(n){n()})}),t.resetNodes=function(){t.$broadcast("resetNodes")},t.showSourceModal=function(){$("#source-modal").modal("show")},t.showTargetModal=function(){$("#target-modal").modal("show")},t.clearDimensions=function(){t.mapping.sourceDimension=null,t.mapping.targetDimension=null},t.zoomIn=function(){t.$broadcast("zoomIn")},t.zoomOut=function(){t.$broadcast("zoomOut")},t.zoomToData=function(){t.$broadcast("zoomToData")},t.setInternalState=function(n){return n},t.readInternalState=function(n){return n},t.getSvg=function(){return{}},t.exportSvg=function(i,e){n(t.getSvg(),e)},c.push(i.registerStateFunctions(t.uniqueToggleId,"graphView",s,g)),t.functions&&(t.functions.source=function(n){t.$apply(function(i){i.mapping.sourceDimension=i.fields.filter(function(i){return i.key===n.key})[0]})},t.functions.target=function(n){t.$apply(function(i){i.mapping.targetDimension=i.fields.filter(function(i){return i.key===n.key})[0]})},t.functions.showLinks=function(n){t.$apply(function(i){i.showLinks=n})},t.functions.showLabels=function(n){t.$apply(function(i){i.showLabels=n})},t.functions.nodeSize=function(n){t.$apply(function(i){i.nodeSize=n})},t.functions.zoomOut=function(){t.$apply(function(n){n.zoomOut()})},t.functions.zoomIn=function(){t.$apply(function(n){n.zoomIn()})},t.functions.zoomToData=function(){t.$apply(function(n){n.zoomToData()})})},post:function(n,i,e){i.find(".settings-toggle").click(function(){i.find(".settings").toggleClass("closed")}),n.graphHeight&&i.height(n.graphHeight)}}}}]),angular.module("palladio").run(["$templateCache",function(n){n.put("partials/palladio-graph-component/template.html",'<div class="">\n\n	<div data-palladio-graph-view\n		graph-height="graphHeight"\n		style="margin-bottom: -55px"\n		link-dimension="linkDimension"\n		show-links="showLinks"\n		show-labels="showLabels"\n		highlight-source="highlightSource"\n		highlight-target="highlightTarget"\n		read-internal-state="readInternalState"\n		set-internal-state="setInternalState"\n		get-svg="getSvg"\n		node-size="nodeSize"\n		data-aggregation-type="{{aggregationType}}"\n		data-aggregate-key="{{aggregateKey}}"\n		count-by="{{countBy}}"\n		count-description="{{aggDescription}}">\n\n		<div class="leaflet-top leaflet-left">\n			<div class="leaflet-control-zoom-graph leaflet-bar leaflet-control">\n				<a class="leaflet-control-zoom-in" ng-click="zoomIn()" title="Zoom in">+</a>\n				<a class="leaflet-control-zoom-out" ng-click="zoomOut()" title="Zoom out">-</a>\n			</div>\n			<div class="zoom-to-data-control leaflet-bar leaflet-control">\n				<a class="leaflet-control-to-data" title="Zoom to data" ng-click="zoomToData()"><i class="fa fa-object-group"></i></a>\n			</div>\n		</div>\n\n</div>\n\n<!-- Settings -->\n<div class="row" data-ng-show="settings">\n\n    <div class="settings col-lg-4 col-lg-offset-8 col-md-6 col-md-offset-6">\n      <div class="panel panel-default">\n\n        <a class="settings-toggle" data-toggle="tooltip" data-original-title="Settings" data-placement="bottom">\n          <i class="fa fa-bars"></i>\n        </a>\n\n        <div class="panel-body">\n\n          <div class="row">\n            <div class="col-lg-12">\n              <label>Settings</label>\n            </div>\n          </div>\n\n          <div class="row margin-top">\n            <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 text-right">\n              <label class="inline">Source</label>\n            </div>\n            <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8 col-condensed">\n              <span class="btn btn-default" ng-click="showSourceModal()">\n                  {{mapping.sourceDimension.description || "Choose"}}\n                  <span class="caret"></span>\n              </span>\n            </div>\n          </div>\n\n					<div class="row margin-top">\n						<div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 text-right">\n							<label class="inline">Highlight</label>\n						</div>\n						<div class="col-lg-8 col-md-8 col-md-8 col-xs-8 col-condensed">\n								<input type="checkbox" ng-model="highlightSource">\n						</div>\n					</div>\n\n					<div class="row margin-top">\n            <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 text-right">\n              <label class="inline">Target</label>\n            </div>\n            <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8 col-condensed">\n              <span class="btn btn-default" ng-click="showTargetModal()">\n                  {{mapping.targetDimension.description || "Choose"}}\n                  <span class="caret"></span>\n              </span>\n            </div>\n          </div>\n\n					<div class="row margin-top">\n						<div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 text-right">\n							<label class="inline">Highlight</label>\n						</div>\n						<div class="col-lg-8 col-md-8 col-md-8 col-xs-8 col-condensed">\n								<input type="checkbox" ng-model="highlightTarget">\n						</div>\n					</div>\n\n\n					<div class="row margin-top">\n						<div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 text-right">\n							<label class="inline">Show links</label>\n						</div>\n						<div class="col-lg-8 col-md-8 col-md-8 col-xs-8 col-condensed">\n								<input type="checkbox" ng-model="showLinks">\n						</div>\n					</div>\n\n					<div class="row margin-top">\n						<div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 text-right">\n							<label class="inline">Size nodes</label>\n						</div>\n						<div class="col-lg-8 col-md-8 col-md-8 col-xs-8 col-condensed">\n								<input type="checkbox" ng-model="nodeSize">\n						</div>\n					</div>\n\n					<div class="row margin-top" data-ng-show="nodeSize">\n						<div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 text-right ">\n							<label class="inline">According to</label>\n						</div>\n						<div class="col-lg-8 col-md-8 col-md-8 col-xs-8 col-condensed">\n							<span class="btn btn-default" ng-click="showAggModal()">\n								{{getAggDescription(aggDim) || "Choose"}}\n								<span class="caret"></span>\n							</span>\n						</div>\n					</div>\n\n					<div class="row margin-top">\n						<div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 text-right ">\n						</div>\n						<div class="col-lg-8 col-md-8 col-md-8 col-xs-8 col-condensed">\n							<a class="pull-right"\n							tooltip="Download graph (svg)"\n							tooltip-animation="false"\n							tooltip-append-to-body="true"\n							ng-click="exportSvg(this, \'Palladio Graph.svg\')">\n								<i class="fa fa-download margin-right"></i>Download\n							</a>\n						</div>\n					</div>\n\n\n\n\n\n        </div>\n\n      </div>\n    </div>\n\n</div>\n\n<div id="{{uniqueModalId}}">\n	<div id="source-modal" data-modal description="Choose source dimension" dimensions="fields" model="mapping.sourceDimension"></div>\n	<div id="target-modal" data-modal description="Choose target dimension" dimensions="fields" model="mapping.targetDimension"></div>\n	<div id="agg-modal" data-modal description="Choose aggregation for sizing nodes" dimensions="aggDims" model="aggDim" description-accessor="getAggDescription"></div>\n</div>\n')}]);