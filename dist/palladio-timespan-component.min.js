angular.module("palladioTimespanComponent",["palladio","palladio.services"]).run(["componentService",function(t){var e=function(t,e){t.showControls=void 0===t.showControls?!0:t.showControls,t.showAccordion=void 0===t.showAccordion?!0:t.showAccordion,t.showSettings=void 0===t.showSettings?!0:t.showSettings,t.fullWidth=void 0===t.fullWidth?!1:t.fullWidth,t.fullHeight=void 0===t.fullHeight?!1:t.fullHeight,t.view=void 0===t.view?!1:t.view,t.functions={};var n="<div data-palladio-partime-filter ";return n+="show-controls=showControls ",n+="show-accordion=showAccordion ",n+="show-settings=showSettings ",n+="full-width=fullWidth ",n+="full-height=fullHeight ",n+="functions=functions ",n+="view=view ",n+="></div>"};t.register("timespan",e)}]).directive("palladioPartimeFilter",["dateService","palladioService","dataService","filterService",function(t,e,n,a){var l={scope:{fullHeight:"=",fullWidth:"=",showControls:"=",showAccordion:"=",showSettings:"=",view:"=",functions:"="},templateUrl:"partials/palladio-timespan-component/template.html",link:{pre:function(t){t.uniqueToggleId="partimeFilter"+Math.floor(1e4*Math.random()),t.uniqueToggleHref="#"+t.uniqueToggleId,t.uniqueModalId=t.uniqueToggleId+"modal",t.metadata=n.getDataSync().metadata,t.xfilter=n.getDataSync().xfilter,t.dateDims=t.metadata.filter(function(t){return"date"===t.type}),t.dateStartDim=t.dateDims[0],t.dateEndDim=t.dateDims[1]?t.dateDims[1]:t.dateDims[0],t.labelDims=t.metadata,t.tooltipLabelDim=t.labelDims[0],t.groupDim=t.labelDims[0],t.title="Time Span Filter",t.stepModes=["Bars","Parallel","Grouped Bars"],t.stepMode=t.stepModes[0],t.collapse=!1,t.toggleCollapse=function(){t.collapse=!t.collapse},t.showDateStartModal=function(){$("#"+t.uniqueModalId).find("#date-start-modal").modal("show")},t.showDateEndModal=function(){$("#"+t.uniqueModalId).find("#date-end-modal").modal("show")},t.showTooltipLabelModal=function(){$("#"+t.uniqueModalId).find("#tooltip-label-modal").modal("show")},t.showGroupModal=function(){$("#"+t.uniqueModalId).find("#group-modal").modal("show")},t.functions&&(t.functions.startDimension=function(e){t.$apply(function(t){t.dateStartDim=t.dateDims.filter(function(t){return t.key===e.key})[0]})},t.functions.endDimension=function(e){t.$apply(function(t){t.dateEndDim=t.dateDims.filter(function(t){return t.key===e.key})[0]})},t.functions.tooltipDimension=function(e){t.$apply(function(t){t.tooltipLabelDim=t.labelDims.filter(function(t){return t.key===e.key})[0]})},t.functions.groupDimension=function(e){t.$apply(function(t){t.groupDim=t.labelDims.filter(function(t){return t.key===e.key})[0]})})},post:function(n,l){function i(){if(f=d3.select(d3.select(l[0]).select(".main-viz")[0][0].children[0]),f.select("svg").empty()||f.select("svg").remove(),g=f.append("svg"),f.attr("width",_+2*V),f.attr("height",J+2*V),g.attr("width",_+2*V),g.attr("height",J+2*V),S=d3.svg.brush(),M=d3.svg.brush(),E=d3.svg.brush(),n.dateStartDim&&n.dateEndDim&&n.tooltipLabelDim&&n.groupDim){v&&v.remove(),v=n.xfilter.dimension(function(t){return""!==P.reformatExternal(t[n.dateStartDim.key])&&""!==P.reformatExternal(t[n.dateEndDim.key])||P.reformatExternal(t[n.dateStartDim.key])===P.reformatExternal(t[n.dateEndDim.key])?[P.reformatExternal(t[n.dateStartDim.key]),P.reformatExternal(t[n.dateEndDim.key]),t[n.tooltipLabelDim.key],t[n.groupDim.key]]:""===P.reformatExternal(t[n.dateStartDim.key])?[void 0,P.reformatExternal(t[n.dateEndDim.key]),t[n.tooltipLabelDim.key],t[n.groupDim.key]]:[P.reformatExternal(t[n.dateStartDim.key]),void 0,t[n.tooltipLabelDim.key],t[n.groupDim.key]]}),h=v.group(),o(),G=d3.svg.axis().orient("bottom").scale(y),F=d3.svg.axis().orient("top").scale(y);var t=[],i=[],s=[];z=function(t){return t[0]?P.parse(t[0]):P.parse(t[1])},B=function(t){return t[1]?P.parse(t[1]):P.parse(t[0])},T=function(e){return(0===t.length||e[1]&&t[0]<=P.parse(e[1])&&P.parse(e[1])<=t[1])&&(0===i.length||e[0]&&i[0]<=P.parse(e[0])&&P.parse(e[0])<=i[1])&&(0===s.length||!(s[0]>z(e)&&s[0]>B(e))&&!(s[1]<z(e)&&s[1]<B(e)))},b=function(){var a=[];i.length&&a.push(n.dateStartDim.description+" from "+P(i[0])+" to "+P(i[1])),s.length&&a.push("between "+P(s[0])+" and  "+P(s[1])),t.length&&a.push(n.dateEndDim.description+" from "+P(t[0])+" to "+P(t[1])),a.length?(N.push(e.setFilter(n.uniqueToggleId,n.title,a.join(", "),n.filterReset)),e.update()):w()},w=function(){e.removeFilter(n.uniqueToggleId),e.update()};var r=function(){};S=d3.svg.brush().x(k),S.on("brush",function(){t=S.empty()?[]:S.extent(),r=function(t){t.filterFunction(T)},a.filter(v,r),e.update()}),S.on("brushend",function(){b()}),M=d3.svg.brush().x(x),M.on("brush",function(){i=M.empty()?[]:M.extent(),r=function(t){t.filterFunction(T)},a.filter(v,r),e.update()}),M.on("brushend",function(){b()}),E=d3.svg.brush().x(y),E.on("brush",function(){s=E.empty()?[]:E.extent(),r=function(t){t.filterFunction(T)},a.filter(v,r),e.update()}),E.on("brushend",function(){b()});var d=g.append("g").attr("transform","translate(10,"+V+")");A=d.append("g").attr("class","axis x-axis").attr("transform","translate(0,"+J+")").call(M).call(G),A.selectAll("rect").attr("height",V),C=d.append("g").attr("class","axis x-axis").call(S).call(F),C.selectAll("rect").attr("height",V).attr("transform","translate(0,-"+V+")"),L=d.append("g").attr("transform","translate(0,"+(V+.5)+")").call(E),L.selectAll("rect").attr("height",J-1).attr("transform","translate(0,-"+V+")"),d.selectAll(".extent").attr("fill",K).attr("opacity",.6),I=d.select(".timespan-tooltip"),I.empty()&&(I=d.append("g").attr("class","timespan-tooltip").attr("pointer-events","none").style("display","none"),I.append("foreignObject").attr("width",100).attr("height",26).attr("pointer-events","none").append("html").style("background-color","rgba(0,0,0,0)").append("div").style("padding-left",3).style("padding-right",3).style("text-align","center").style("white-space","nowrap").style("overflow","hidden").style("text-overflow","ellipsis").style("border-radius","5px").style("background-color","white").style("border","3px solid grey"))}}function o(){d();var t=h.all().map(function(t){return t.key[0]}).filter(function(t){return P.parse(t).valueOf()}),e=h.all().map(function(t){return t.key[1]}).filter(function(t){return P.parse(t).valueOf()}),n=t.concat(e).map(function(t){return P.parse(t)});y=d3.time.scale().range([0,_]).domain([d3.min(n),d3.max(n)]),x=d3.time.scale().range([0,_]).domain([d3.min(n),d3.max(n)]),k=d3.time.scale().range([0,_]).domain([d3.min(n),d3.max(n)]),D=d3.scale.linear().range([J,0]).domain([0,1]),q=d3.scale.linear().range([J,0]).domain([-1,j.length])}function s(){S.x(k),M.x(x),E.x(y),A.call(M).call(G),C.call(S).call(F),L.call(E)}function r(t){return T(t.key)?"#555555":"#CCCCCC"}function d(){j=h.top(1/0).filter(function(t){return(""!==t.key[0]||""!==t.key[1])&&0!==t.value}).sort(function(t,e){return"Grouped Bars"!==n.stepMode||t.key[3]===e.key[3]?t.key[0]<e.key[0]?-1:1:t.key[3]<e.key[3]?-1:1});var t=j.map(function(t){return t.key.slice(0,3).join()});j=j.filter(function(e){return"Grouped Bars"!==n.stepMode?t.indexOf(e.key.slice(0,3).join())===t.lastIndexOf(e.key.slice(0,3).join()):!0})}function c(){if(g&&n.dateStartDim&&n.dateEndDim&&n.tooltipLabelDim&&n.groupDim){o(),s();var t=g.select("g").selectAll(".path").data(j,function(t){return t.key[0]+" - "+t.key[1]+" - "+t.key[3]});t.exit().remove();var e=t.enter().append("g").attr("class","path");e.tooltip(function(t){return{text:t.key[2]+" ("+t.key[3]+"): "+t.key[0]+" - "+t.key[1],displacement:[0,20],position:[0,0],gravity:"right",placement:"mouse",mousemove:!0}}),e.append("circle").attr("class","path-start").attr("r",O).attr("fill-opacity",.8).attr("stroke-opacity",.8).attr("stroke-width",H).style("display",function(t){return t.key[0]?"inline":"none"}).on("mouseover",R).on("mouseout",U),e.append("circle").attr("class","path-end").attr("r",O).attr("fill-opacity",.8).attr("stroke-opacity",.8).attr("stroke-width",H).style("display",function(t){return t.key[1]?"inline":"none"}).on("mouseover",R).on("mouseout",U),e.append("line").attr("stroke-width",1).attr("stroke-opacity",H).style("display",function(t){return t.key[0]&&t.key[1]?"inline":"none"}).on("mouseover",R).on("mouseout",U);var a=t.selectAll("line"),l=t.selectAll("circle"),i=t.selectAll(".path-start"),d=t.selectAll(".path-end");a.attr("stroke",r),l.attr("stroke",r),l.attr("fill",r),"Bars"===n.stepMode||"Grouped Bars"===n.stepMode?(q.domain([-1,j.length]),a.transition().attr("x1",function(t){return y(z(t.key))}).attr("y1",0).attr("x2",function(t){return y(B(t.key))}).attr("y2",0),i.attr("cx",function(t){return y(z(t.key))}),d.attr("cx",function(t){return y(B(t.key))}),t.transition().attr("transform",function(t,e){return"translate(0,"+q(e)+")"}),i.attr("transform","translate(0,0)")):(i.attr("transform","translate(0,"+D(0)+")"),a.transition().attr("x1",function(t){return y(z(t.key))}).attr("y1",D(0)).attr("x2",function(t){return y(B(t.key))}).attr("y2",D(1)),t.transition().attr("transform","translate(0,0)"))}}function m(){h&&h.remove(),v&&(v.filterAll(),v.remove(),w()),g&&g.remove(),e.update()}function p(e){n.title=e.title,n.dateStartDim=n.dateDims.filter(function(t){return t.key===e.dateStartDim})[0],n.dateEndDim=n.dateDims.filter(function(t){return t.key===e.dateEndDim})[0],n.tooltipLabelDim=n.labelDims.filter(function(t){return t.key===e.tooltipLabelDim})[0],n.$digest(),S.extent(e.topExtent.map(function(e){return t.format.parse(e)})),E.extent(e.midExtent.map(function(e){return t.format.parse(e)})),M.extent(e.bottomExtent.map(function(e){return t.format.parse(e)})),C&&L&&A&&(S.event(C),E.event(L),M.event(A),C.call(S),L.call(E),A.call(M)),n.stepMode=e.mode}function u(){return{title:n.title,dateStartDim:n.dateStartDim?n.dateStartDim.key:void 0,dateEndDim:n.dateEndDim?n.dateEndDim.key:void 0,tooltipLabelDim:n.tooltipLabelDim?n.tooltipLabelDim.key:void 0,topExtent:S&&S.extent()?S.extent().map(function(e){return t.format(e)}):[],midExtent:E&&E.extent()?E.extent().map(function(e){return t.format(e)}):[],bottomExtent:M&&M.extent()?M.extent().map(function(e){return t.format(e)}):[],mode:n.stepMode}}var f,g,v,h,y,D,x,k,b,w,S,E,M,C,A,L,T,q,I,G,F,j,z,B,H=.8,W=1.5,O=1,R=function(t){g.select("g").selectAll(".path").filter(function(e){return e.key.slice(0,3).join()===t.key.slice(0,3).join()}).selectAll("*").attr("stroke","#222222").attr("stroke-width",W)},U=function(t){g.select("g").selectAll(".path").filter(function(e){return e.key.slice(0,3).join()===t.key.slice(0,3).join()}).selectAll("*").attr("stroke",r).attr("stroke-width",H)},P=t.format;l.find(".main-viz").parent().addClass(n.showSettings?"col-lg-9":"col-lg-12"),l.find(".main-viz").parent().addClass(n.showSettings?"col-md-8":"col-md-12");var V=25,_=n.fullWidth?l.find(".main-viz").width()-2*V:l.find(".main-viz").width(),J=n.height?+n.height:270;J=n.fullHeight?$(window).height()-200:J;var K="#9DBCE4";n.filterReset=function(){m(),i(),c()},n.$watchGroup(["dateStartDim","dateEndDim","tooltipLabelDim","groupDim"],function(){m(),i(),c()}),n.$watch("stepMode",function(t,e){void 0!==t&&c()}),n.saveAsSVG=function(){var t=new SvgSaver,e=l.find("svg")[0];console.log(e),t.asSvg(e,"Palladio_timespan_"+n.title+".svg")};var N=[];N.push(e.onReset(n.uniqueToggleId,function(){n.filterReset()})),N.push(e.onUpdate(n.uniqueToggleId,function(){c()})),n.$on("$destroy",function(){v&&(v.filterAll(),h.remove(),v.remove(),v=void 0),N.forEach(function(t){t()}),N=[]}),N.push(e.registerStateFunctions(n.uniqueToggleId,"partime",u,p)),$(l[0]).find("#date-start-modal").parent().appendTo("body"),n.view&&$(document).ready(function(){$(l[0]).find(".toggle").click(function(){$(l[0]).find(".settings").toggleClass("open close")})})}}};return l}]),angular.module("palladio").run(["$templateCache",function(t){t.put("partials/palladio-timespan-component/template.html",'<div class="row" ng-show="collapse" ng-init="collapse=false">\n	<div class="col-lg-12">\n		{{title}}<span class="text-muted margin-left small">Timespan</span>\n		<a class="btn btn-default btn-xs pull-right"\n			tooltip-animation="false"\n			tooltip-append-to-body="true"\n			tooltip-placement="left"\n			tooltip="Expand"\n			ng-click="collapse=false">\n			<i class="fa fa-chevron-up"></i>\n		</a>\n	</div>\n</div>\n\n<div class="row" ng-show="!collapse">\n\n	<div>\n\n		<div class="main-viz">\n			<div id="{{uniqueToggleId}}"></div>\n		</div>\n\n		<div class="well well-expand" ng-show="!dateEndDim || !dateStartDim || !groupDim">Select an Upper date, a Lower date and a Group dimension on the right</div>\n\n	</div>\n\n	<div data-ng-show="showSettings" class="col-lg-3">\n\n		<div class="row">\n			<div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 text-right ">\n				<label class="inline text-muted">Timespan</label>\n			</div>\n			<div ng-show="showAccordion" class="col-lg-8 col-md-8 col-md-8 col-xs-8 col-condensed">\n				<a class="btn btn-default btn-xs pull-right"\n					tooltip-animation="false"\n					tooltip-append-to-body="true"\n					tooltip-placement="left"\n					tooltip="Collapse"\n					ng-click="collapse=true">\n					<i class="fa fa-chevron-down"></i>\n				</a>\n			</div>\n		</div>\n\n		<div class="row margin-top">\n			<div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 text-right ">\n				<label class="inline">Description</label>\n			</div>\n			<div class="col-lg-8 col-md-8 col-md-8 col-xs-8 col-condensed">\n				<input type="text" class="form-control" data-ng-model="title" placeholder="Untitled"></input>\n			</div>\n		</div>\n\n		<div class="row margin-top">\n			<div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 text-right ">\n				<label class="inline">Layout</label>\n			</div>\n			<div class="col-lg-8 col-md-8 col-md-8 col-xs-8 col-condensed">\n				<ui-select ng-model="$parent.stepMode" theme="selectize">\n					<ui-select-match placeholder="Select">\n						{{$select.selected}}\n						<span class="caret"></span>\n					</ui-select-match>\n				    <ui-select-choices repeat="mode in stepModes">\n				      <span ng-bind-html="mode"></span>\n				    </ui-select-choices>\n				</ui-select>\n			</div>\n		</div>\n\n		<div class="row margin-top">\n			<div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 text-right ">\n				<label class="inline">Start date</label>\n			</div>\n			<div class="col-lg-8 col-md-8 col-md-8 col-xs-8 col-condensed">\n				<span class="btn btn-default btn-modal" ng-click="showDateStartModal()">\n					{{dateStartDim.description || "Choose"}}\n					<span class="caret"></span>\n				</span>\n			</div>\n		</div>\n\n		<div class="row margin-top">\n			<div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 text-right ">\n				<label class="inline">End date</label>\n			</div>\n			<div class="col-lg-8 col-md-8 col-md-8 col-xs-8 col-condensed">\n				<span class="btn btn-default btn-modal" ng-click="showDateEndModal()">\n					{{dateEndDim.description || "Choose"}}\n					<span class="caret"></span>\n				</span>\n			</div>\n		</div>\n\n		<div class="row margin-top">\n			<div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 text-right ">\n				<label class="inline">Label</label>\n			</div>\n			<div class="col-lg-8 col-md-8 col-md-8 col-xs-8 col-condensed">\n				<span class="btn btn-default btn-modal" ng-click="showTooltipLabelModal()">\n					{{tooltipLabelDim.description || "Choose"}}\n					<span class="caret"></span>\n				</span>\n			</div>\n		</div>\n\n		<div class="row margin-top">\n			<div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 text-right ">\n				<label class="inline">Group</label>\n			</div>\n			<div class="col-lg-8 col-md-8 col-md-8 col-xs-8 col-condensed">\n				<span class="btn btn-default btn-modal" ng-click="showGroupModal()">\n					{{groupDim.description || "Choose"}}\n					<span class="caret"></span>\n				</span>\n			</div>\n		</div>\n\n		<div data-ng-show="showControls" class="row margin-top">\n			<div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 text-right ">\n			</div>\n			<div class="col-lg-8 col-md-8 col-md-8 col-xs-8 col-condensed">\n\n				<a class="small" data-ng-click="filterReset()">Clear</a>\n        <a class="small" data-ng-click="saveAsSVG()"\n          tooltip-animation="false"\n				 	tooltip-append-to-body="true"\n					tooltip-placement="top"\n					tooltip="Download as SVG">\n          \n          <i class="fa fa-download"></i>\n        </a>\n\n				<a class="text-danger pull-right"\n					tooltip-animation="false"\n					tooltip-append-to-body="true"\n					tooltip-placement="left"\n					tooltip="Delete filter"\n					data-ng-click="$parent.removeFilter($event)">\n					<i class="fa fa-trash-o"></i>\n				</a>\n			</div>\n		</div>\n\n\n	</div>\n\n</div>\n\n<div id="{{uniqueModalId}}">\n	<div id="date-start-modal" data-modal dimensions="dateDims" model="dateStartDim"></div>\n	<div id="date-end-modal" data-modal dimensions="dateDims" model="dateEndDim"></div>\n	<div id="tooltip-label-modal" data-modal dimensions="labelDims" model="tooltipLabelDim"></div>\n	<div id="group-modal" data-modal dimensions="labelDims" model="groupDim"></div>\n</div>')}]);